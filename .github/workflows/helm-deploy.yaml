---
name: Helm Deploy Triton Platform + Monitoring

"on":
  workflow_run:
    workflows: ["Terraform Infra Provision"]
    types:
      - completed

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TRITON_NAMESPACE: triton
  MONITORING_NAMESPACE: monitoring

jobs:

  deploy:
    name: Deploy Triton + Monitoring Stack
    runs-on: ubuntu-latest
    environment: production

    steps:
      # ------------------------------
      # CHECKOUT
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # AWS Auth via OIDC
      # ------------------------------
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ------------------------------
      # Install CLI Tools
      # ------------------------------
      - name: Install kubectl
        uses: aws/setup-kubectl@v4

      - name: Install Helm
        uses: aws/setup-helm@v4

      # ------------------------------
      # Kubeconfig for EKS
      # ------------------------------
      - name: Configure kubeconfig for EKS
        run: |
          CLUSTER_NAME=$(
            terraform -chdir=infra/terraform \
               output -raw eks_cluster_name)
               aws eks update-kubeconfig \
               --region $AWS_REGION \
                --name $CLUSTER_NAME

      - name: Verify K8s Connection
        run: kubectl get nodes

      # ------------------------------
      # Create Alertmanager Secret (Slack webhook only in GitHub Secrets)
      # ------------------------------
      - name: Create Alertmanager Config Secret
        run: |
          cat <<EOF > alertmanager.yaml
          global:
            resolve_timeout: 5m

          route:
            receiver: "slack"

          receivers:
            - name: "slack"
              slack_configs:
                - api_url: "${{ secrets.SLACK_WEBHOOK_URL }}"
                  channel: "${{ secrets.SLACK_CHANNEL }}"
                  send_resolved: true
                  title: "Triton GPU Alert"
                  text: "Alert: {{ .CommonAnnotations.summary }}"

          EOF

          kubectl -n $MONITORING_NAMESPACE delete secret alertmanager-main \
          --ignore-not-found

          kubectl -n $MONITORING_NAMESPACE create secret generic \
          alertmanager-main \
          --from-file=alertmanager.yaml

      # ------------------------------
      # Wait for monitoring stack (terraform-managed prometheus stack)
      # ------------------------------
      - name: Wait for Prometheus Operator readiness
        run: |
          kubectl -n $MONITORING_NAMESPACE rollout status \
          deployment/kube-prometheus-stack-operator \
          --timeout=5m

      # ------------------------------
      # DEPLOY TRITON (Helm Chart Generated)
      # ------------------------------
      - name: Deploy Triton Inference Server
        run: |
          helm upgrade --install triton \
            services/triton/helm \
            --namespace $TRITON_NAMESPACE \
            --create-namespace \
            -f services/triton/helm/values.yaml

      - name: Wait for Triton Deployment
        run: |
          kubectl -n $TRITON_NAMESPACE rollout status \
          deployment/triton \
          --timeout=5m

      # ------------------------------
      # NVIDIA DCGM Exporter (GPU Metrics)
      # ------------------------------
      - name: Deploy NVIDIA DCGM Exporter
        run: |
          helm repo add nvidia https://nvidia.github.io/dcgm-exporter
          helm repo update
          helm upgrade --install dcgm-exporter \
            nvidia/dcgm-exporter \
            --namespace $MONITORING_NAMESPACE \
            --create-namespace

      # ------------------------------
      # DONE
      # ------------------------------
      - name: Complete
        run: echo "Triton + Monitoring stack deployed successfully!"
