---
name: Helm Deploy Triton Platform + Monitoring

on:
  workflow_run:
    workflows: ["Terraform Infra Provision"]
    types: [completed]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TRITON_NAMESPACE: triton
  MONITORING_NAMESPACE: monitoring

jobs:

  deploy:
    name: Deploy Triton + Monitoring Stack
    runs-on: ubuntu-latest
    environment: production

    steps:
      # ------------------------------
      # CHECKOUT
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # AWS Auth via OIDC
      # ------------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com
          output-env-credentials: true

      # ------------------------------
      # Install CLIs
      # ------------------------------
      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------
      # Inject cluster name from secrets
      # ------------------------------
      - name: Set EKS Cluster Name
        run: |
          echo "EKS_CLUSTER_NAME=${{ secrets.EKS_CLUSTER_NAME }}" \
            >> "$GITHUB_ENV"

      # ------------------------------
      # Update Kubeconfig
      # ------------------------------
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region "$AWS_REGION" \
            --name "$EKS_CLUSTER_NAME"

          kubectl config view
          kubectl get nodes

      # ------------------------------
      # Wait for Monitoring Stack
      # ------------------------------
      - name: Wait for Prometheus Operator
        run: |
          set -e
          echo "Waiting for Prometheus Operator..."

          kubectl -n "$MONITORING_NAMESPACE" rollout status \
            deployment/kube-prometheus-stack-operator \
            --timeout=5m || {

            echo "Trying fallback deployment..."
            kubectl -n "$MONITORING_NAMESPACE" rollout status \
              deployment/prometheus-operator \
              --timeout=5m
          }

      # ------------------------------
      # Deploy Triton Manifests
      # ------------------------------
      - name: Deploy Triton Manifests
        run: |
          kubectl apply -f k8s/triton-deployment.yaml
          kubectl apply -f k8s/triton-models-pvc.yaml
          kubectl apply -f k8s/triton-service.yaml

      # ------------------------------
      # Deploy Triton server via helm
      # ------------------------------
      - name: Deploy Triton Server
        run: |
          set -e
          helm upgrade --install triton \
            ./services/triton/helm \
            --namespace "$TRITON_NAMESPACE" \
            --create-namespace \
            -f services/triton/helm/values.yaml

      - name: Wait for Triton Deployment
        run: |
          kubectl -n "$TRITON_NAMESPACE" rollout status \
            deployment/triton --timeout=5m

      # ------------------------------
      # Deploy NVIDIA DCGM Exporter
      # ------------------------------
      - name: Deploy DCGM Exporter
        run: |
          helm repo add nvidia https://nvidia.github.io/dcgm-exporter
          helm repo update

          helm upgrade --install dcgm-exporter \
            nvidia/dcgm-exporter \
            --namespace "$MONITORING_NAMESPACE" \
            --create-namespace

      # ------------------------------
      # DONE
      # ------------------------------
      - name: Complete
        run: echo "Triton + Monitoring stack deployed successfully!"
